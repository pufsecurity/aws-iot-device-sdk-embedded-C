/***********************************************************************************
 *
 *  Copyright (c) 2023-2024, PUFsecurity
 *  All rights reserved.
 *
 *  Redistribution and use in source and binary forms, with or without modification,
 *  are permitted provided that the following conditions are met:
 *
 *  1. Redistributions of source code must retain the above copyright notice, this
 *     list of conditions and the following disclaimer.
 *
 *  2. Redistributions in binary form must reproduce the above copyright notice,
 *     this list of conditions and the following disclaimer in the documentation
 *     and/or other materials provided with the distribution.
 *
 *  3. Neither the name of PUFsecurity nor the names of its contributors may be
 *     used to endorse or promote products derived from this software without
 *     specific prior written permission.
 *
 *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS” AND
 *  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 *  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 *  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 *  OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 *  EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 **************************************************************************************/


/*!*************************************************************************************
 *
 *@file        pufs_mbedtls_ecdsa.c
 *
 *@brief       Pufsecurity crypto implmentation for Elliptic curve DSA
 *
 *             References:
 *
 *             SEC1 http://www.secg.org/index.php?action=secg,docs_secg
 *
 *@copyright   2023-2024 PUFsecurity
 *
 ***************************************************************************************/

#if !defined(MBEDTLS_CONFIG_FILE)
#include "mbedtls/config.h"
#else
#include MBEDTLS_CONFIG_FILE
#endif

#if defined(MBEDTLS_ECDSA_C)

#include "mbedtls/ecdsa.h"
#include "mbedtls/asn1write.h"

#include <string.h>

#include "pufs_mbedtls_ecdsa.h"
#include "pufs_pkc.h" //pufs_ec_point_st



/**
 * NIST standard elliptic curves
 */
pufs_ecc_param_st ecc_param[] =
{
    { /* NISTB163 */
        "\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc9", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // a
        "\x02\x0a\x60\x19\x07\xb8\xc9\x53\xca\x14\x81\xeb\x10\x51\x2f\x78\x74\x4a\x32\x05\xfd", // b
        "\x03\xf0\xeb\xa1\x62\x86\xa2\xd5\x7e\xa0\x99\x11\x68\xd4\x99\x46\x37\xe8\x34\x3e\x36", // px
        "\x00\xd5\x1f\xbc\x6c\x71\xa0\x09\x4f\xa2\xcd\xd5\x45\xb1\x1c\x5c\x0c\x79\x73\x24\xf1", // py
        "\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x92\xfe\x77\xe7\x0c\x12\xa4\x23\x4c\x33", // order
        163, 163, 0, 2, 21, false,
    },
    { /* NISTB233 */
        "\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x01", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // a
        "\x00\x66\x64\x7e\xde\x6c\x33\x2c\x7f\x8c\x09\x23\xbb\x58\x21\x3b\x33\x3b\x20\xe9\xce\x42\x81\xfe\x11\x5f\x7d\x8f\x90\xad", // b
        "\x00\xfa\xc9\xdf\xcb\xac\x83\x13\xbb\x21\x39\xf1\xbb\x75\x5f\xef\x65\xbc\x39\x1f\x8b\x36\xf8\xf8\xeb\x73\x71\xfd\x55\x8b", // px
        "\x01\x00\x6a\x08\xa4\x19\x03\x35\x06\x78\xe5\x85\x28\xbe\xbf\x8a\x0b\xef\xf8\x67\xa7\xca\x36\x71\x6f\x7e\x01\xf8\x10\x52", // py
        "\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x13\xe9\x74\xe7\x2f\x8a\x69\x22\x03\x1d\x26\x03\xcf\xe0\xd7", // order
        233, 233, 1, 2, 30, false,
    },
    { /* NISTB283 */
        "\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\xa1", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // a
        "\x02\x7b\x68\x0a\xc8\xb8\x59\x6d\xa5\xa4\xaf\x8a\x19\xa0\x30\x3f\xca\x97\xfd\x76\x45\x30\x9f\xa2\xa5\x81\x48\x5a\xf6\x26\x3e\x31\x3b\x79\xa2\xf5", // b
        "\x05\xf9\x39\x25\x8d\xb7\xdd\x90\xe1\x93\x4f\x8c\x70\xb0\xdf\xec\x2e\xed\x25\xb8\x55\x7e\xac\x9c\x80\xe2\xe1\x98\xf8\xcd\xbe\xcd\x86\xb1\x20\x53", // px
        "\x03\x67\x68\x54\xfe\x24\x14\x1c\xb9\x8f\xe6\xd4\xb2\x0d\x02\xb4\x51\x6f\xf7\x02\x35\x0e\xdd\xb0\x82\x67\x79\xc8\x13\xf0\xdf\x45\xbe\x81\x12\xf4", // py
        "\x03\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xef\x90\x39\x96\x60\xfc\x93\x8a\x90\x16\x5b\x04\x2a\x7c\xef\xad\xb3\x07", // order
        283, 282, 2, 2, 36, false,
    },
    { /* NISTB409 */
        "\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // a
        "\x00\x21\xa5\xc2\xc8\xee\x9f\xeb\x5c\x4b\x9a\x75\x3b\x7b\x47\x6b\x7f\xd6\x42\x2e\xf1\xf3\xdd\x67\x47\x61\xfa\x99\xd6\xac\x27\xc8\xa9\xa1\x97\xb2\x72\x82\x2f\x6c\xd5\x7a\x55\xaa\x4f\x50\xae\x31\x7b\x13\x54\x5f", // b
        "\x01\x5d\x48\x60\xd0\x88\xdd\xb3\x49\x6b\x0c\x60\x64\x75\x62\x60\x44\x1c\xde\x4a\xf1\x77\x1d\x4d\xb0\x1f\xfe\x5b\x34\xe5\x97\x03\xdc\x25\x5a\x86\x8a\x11\x80\x51\x56\x03\xae\xab\x60\x79\x4e\x54\xbb\x79\x96\xa7", // px
        "\x00\x61\xb1\xcf\xab\x6b\xe5\xf3\x2b\xbf\xa7\x83\x24\xed\x10\x6a\x76\x36\xb9\xc5\xa7\xbd\x19\x8d\x01\x58\xaa\x4f\x54\x88\xd0\x8f\x38\x51\x4f\x1f\xdf\x4b\x4f\x40\xd2\x18\x1b\x36\x81\xc3\x64\xba\x02\x73\xc7\x06", // py
        "\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xe2\xaa\xd6\xa6\x12\xf3\x33\x07\xbe\x5f\xa4\x7c\x3c\x9e\x05\x2f\x83\x81\x64\xcd\x37\xd9\xa2\x11\x73", // order
        409, 409, 3, 2, 52, false,
    },
    { /* NISTB571 */
        "\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x25", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // a
        "\x02\xf4\x0e\x7e\x22\x21\xf2\x95\xde\x29\x71\x17\xb7\xf3\xd6\x2f\x5c\x6a\x97\xff\xcb\x8c\xef\xf1\xcd\x6b\xa8\xce\x4a\x9a\x18\xad\x84\xff\xab\xbd\x8e\xfa\x59\x33\x2b\xe7\xad\x67\x56\xa6\x6e\x29\x4a\xfd\x18\x5a\x78\xff\x12\xaa\x52\x0e\x4d\xe7\x39\xba\xca\x0c\x7f\xfe\xff\x7f\x29\x55\x72\x7a", // b
        "\x03\x03\x00\x1d\x34\xb8\x56\x29\x6c\x16\xc0\xd4\x0d\x3c\xd7\x75\x0a\x93\xd1\xd2\x95\x5f\xa8\x0a\xa5\xf4\x0f\xc8\xdb\x7b\x2a\xbd\xbd\xe5\x39\x50\xf4\xc0\xd2\x93\xcd\xd7\x11\xa3\x5b\x67\xfb\x14\x99\xae\x60\x03\x86\x14\xf1\x39\x4a\xbf\xa3\xb4\xc8\x50\xd9\x27\xe1\xe7\x76\x9c\x8e\xec\x2d\x19", // px
        "\x03\x7b\xf2\x73\x42\xda\x63\x9b\x6d\xcc\xff\xfe\xb7\x3d\x69\xd7\x8c\x6c\x27\xa6\x00\x9c\xbb\xca\x19\x80\xf8\x53\x39\x21\xe8\xa6\x84\x42\x3e\x43\xba\xb0\x8a\x57\x62\x91\xaf\x8f\x46\x1b\xb2\xa8\xb3\x53\x1d\x2f\x04\x85\xc1\x9b\x16\xe2\xf1\x51\x6e\x23\xdd\x3c\x1a\x48\x27\xaf\x1b\x8a\xc1\x5b", // py
        "\x03\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xe6\x61\xce\x18\xff\x55\x98\x73\x08\x05\x9b\x18\x68\x23\x85\x1e\xc7\xdd\x9c\xa1\x16\x1d\xe9\x3d\x51\x74\xd6\x6e\x83\x82\xe9\xbb\x2f\xe8\x4e\x47", // order
        571, 570, 4, 2, 72, false,
    },
    { /* NISTK163 */
        "\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc9", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // a
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // b
        "\x02\xfe\x13\xc0\x53\x7b\xbc\x11\xac\xaa\x07\xd7\x93\xde\x4e\x6d\x5e\x5c\x94\xee\xe8", // px
        "\x02\x89\x07\x0f\xb0\x5d\x38\xff\x58\x32\x1f\x2e\x80\x05\x36\xd5\x38\xcc\xda\xa3\xd9", // py
        "\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x01\x08\xa2\xe0\xcc\x0d\x99\xf8\xa5\xef", // order
        163, 163, 0, 2, 21, false,
    },
    { /* NISTK233 */
        "\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x01", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", // a
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // b
        "\x01\x72\x32\xba\x85\x3a\x7e\x73\x1a\xf1\x29\xf2\x2f\xf4\x14\x95\x63\xa4\x19\xc2\x6b\xf5\x0a\x4c\x9d\x6e\xef\xad\x61\x26", // px
        "\x01\xdb\x53\x7d\xec\xe8\x19\xb7\xf7\x0f\x55\x5a\x67\xc4\x27\xa8\xcd\x9b\xf1\x8a\xeb\x9b\x56\xe0\xc1\x10\x56\xfa\xe6\xa3", // py
        "\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06\x9d\x5b\xb9\x15\xbc\xd4\x6e\xfb\x1a\xd5\xf1\x73\xab\xdf", // order
        233, 232, 1, 4, 30, false,
    },
    { /* NISTK283 */
        "\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\xa1", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", // a
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // b
        "\x05\x03\x21\x3f\x78\xca\x44\x88\x3f\x1a\x3b\x81\x62\xf1\x88\xe5\x53\xcd\x26\x5f\x23\xc1\x56\x7a\x16\x87\x69\x13\xb0\xc2\xac\x24\x58\x49\x28\x36", // px
        "\x01\xcc\xda\x38\x0f\x1c\x9e\x31\x8d\x90\xf9\x5d\x07\xe5\x42\x6f\xe8\x7e\x45\xc0\xe8\x18\x46\x98\xe4\x59\x62\x36\x4e\x34\x11\x61\x77\xdd\x22\x59", // py
        "\x01\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xe9\xae\x2e\xd0\x75\x77\x26\x5d\xff\x7f\x94\x45\x1e\x06\x1e\x16\x3c\x61", // order
        283, 281, 2, 4, 36, false,
    },
    { /* NISTK409 */
        "\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", // a
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // b
        "\x00\x60\xf0\x5f\x65\x8f\x49\xc1\xad\x3a\xb1\x89\x0f\x71\x84\x21\x0e\xfd\x09\x87\xe3\x07\xc8\x4c\x27\xac\xcf\xb8\xf9\xf6\x7c\xc2\xc4\x60\x18\x9e\xb5\xaa\xaa\x62\xee\x22\x2e\xb1\xb3\x55\x40\xcf\xe9\x02\x37\x46", // px
        "\x01\xe3\x69\x05\x0b\x7c\x4e\x42\xac\xba\x1d\xac\xbf\x04\x29\x9c\x34\x60\x78\x2f\x91\x8e\xa4\x27\xe6\x32\x51\x65\xe9\xea\x10\xe3\xda\x5f\x6c\x42\xe9\xc5\x52\x15\xaa\x9c\xa2\x7a\x58\x63\xec\x48\xd8\xe0\x28\x6b", // py
        "\x00\x7f\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe\x5f\x83\xb2\xd4\xea\x20\x40\x0e\xc4\x55\x7d\x5e\xd3\xe3\xe7\xca\x5b\x4b\x5c\x83\xb8\xe0\x1e\x5f\xcf", // order
        409, 407, 3, 4, 52, false,
    },
    { /* NISTK571 */
        "\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x25", // irreducible polynomial
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", // a
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // b
        "\x02\x6e\xb7\xa8\x59\x92\x3f\xbc\x82\x18\x96\x31\xf8\x10\x3f\xe4\xac\x9c\xa2\x97\x00\x12\xd5\xd4\x60\x24\x80\x48\x01\x84\x1c\xa4\x43\x70\x95\x84\x93\xb2\x05\xe6\x47\xda\x30\x4d\xb4\xce\xb0\x8c\xbb\xd1\xba\x39\x49\x47\x76\xfb\x98\x8b\x47\x17\x4d\xca\x88\xc7\xe2\x94\x52\x83\xa0\x1c\x89\x72", // px
        "\x03\x49\xdc\x80\x7f\x4f\xbf\x37\x4f\x4a\xea\xde\x3b\xca\x95\x31\x4d\xd5\x8c\xec\x9f\x30\x7a\x54\xff\xc6\x1e\xfc\x00\x6d\x8a\x2c\x9d\x49\x79\xc0\xac\x44\xae\xa7\x4f\xbe\xbb\xb9\xf7\x72\xae\xdc\xb6\x20\xb0\x1a\x7b\xa7\xaf\x1b\x32\x04\x30\xc8\x59\x19\x84\xf6\x01\xcd\x4c\x14\x3e\xf1\xc7\xa3", // py
        "\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x13\x18\x50\xe1\xf1\x9a\x63\xe4\xb3\x91\xa8\xdb\x91\x7f\x41\x38\xb6\x30\xd8\x4b\xe5\xd6\x39\x38\x1e\x91\xde\xb4\x5c\xfe\x77\x8f\x63\x7c\x10\x01", // order
        571, 570, 4, 4, 72, false,
    },
    { /* NISTP192 */
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xff", // prime
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xfc", // a
        "\x64\x21\x05\x19\xe5\x9c\x80\xe7\x0f\xa7\xe9\xab\x72\x24\x30\x49\xfe\xb8\xde\xec\xc1\x46\xb9\xb1", // b
        "\x18\x8d\xa8\x0e\xb0\x30\x90\xf6\x7c\xbf\x20\xeb\x43\xa1\x88\x00\xf4\xff\x0a\xfd\x82\xff\x10\x12", // px
        "\x07\x19\x2b\x95\xff\xc8\xda\x78\x63\x10\x11\xed\x6b\x24\xcd\xd5\x73\xf9\x77\xa1\x1e\x79\x48\x11", // py
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x99\xde\xf8\x36\x14\x6b\xc9\xb1\xb4\xd2\x28\x31", // order
        192, 192, 0, 1, 24, true,
    },
    { /* NISTP224 */
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01", // prime
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe", // a
        "\xb4\x05\x0a\x85\x0c\x04\xb3\xab\xf5\x41\x32\x56\x50\x44\xb0\xb7\xd7\xbf\xd8\xba\x27\x0b\x39\x43\x23\x55\xff\xb4", // b
        "\xb7\x0e\x0c\xbd\x6b\xb4\xbf\x7f\x32\x13\x90\xb9\x4a\x03\xc1\xd3\x56\xc2\x11\x22\x34\x32\x80\xd6\x11\x5c\x1d\x21", // px
        "\xbd\x37\x63\x88\xb5\xf7\x23\xfb\x4c\x22\xdf\xe6\xcd\x43\x75\xa0\x5a\x07\x47\x64\x44\xd5\x81\x99\x85\x00\x7e\x34", // py
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x16\xa2\xe0\xb8\xf0\x3e\x13\xdd\x29\x45\x5c\x5c\x2a\x3d", // order
        224, 224, 1, 1, 28, true,
    },
    { /* NISTP256 */
        "\xff\xff\xff\xff\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff", // prime
        "\xff\xff\xff\xff\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfc", // a
        "\x5a\xc6\x35\xd8\xaa\x3a\x93\xe7\xb3\xeb\xbd\x55\x76\x98\x86\xbc\x65\x1d\x06\xb0\xcc\x53\xb0\xf6\x3b\xce\x3c\x3e\x27\xd2\x60\x4b", // b
        "\x6b\x17\xd1\xf2\xe1\x2c\x42\x47\xf8\xbc\xe6\xe5\x63\xa4\x40\xf2\x77\x03\x7d\x81\x2d\xeb\x33\xa0\xf4\xa1\x39\x45\xd8\x98\xc2\x96", // px
        "\x4f\xe3\x42\xe2\xfe\x1a\x7f\x9b\x8e\xe7\xeb\x4a\x7c\x0f\x9e\x16\x2b\xce\x33\x57\x6b\x31\x5e\xce\xcb\xb6\x40\x68\x37\xbf\x51\xf5", // py
        "\xff\xff\xff\xff\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xbc\xe6\xfa\xad\xa7\x17\x9e\x84\xf3\xb9\xca\xc2\xfc\x63\x25\x51", // order
        256, 256, 2, 1, 32, true,
    },
    { /* NISTP384 */
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff", // prime
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xfc", // a
        "\xb3\x31\x2f\xa7\xe2\x3e\xe7\xe4\x98\x8e\x05\x6b\xe3\xf8\x2d\x19\x18\x1d\x9c\x6e\xfe\x81\x41\x12\x03\x14\x08\x8f\x50\x13\x87\x5a\xc6\x56\x39\x8d\x8a\x2e\xd1\x9d\x2a\x85\xc8\xed\xd3\xec\x2a\xef", // b
        "\xaa\x87\xca\x22\xbe\x8b\x05\x37\x8e\xb1\xc7\x1e\xf3\x20\xad\x74\x6e\x1d\x3b\x62\x8b\xa7\x9b\x98\x59\xf7\x41\xe0\x82\x54\x2a\x38\x55\x02\xf2\x5d\xbf\x55\x29\x6c\x3a\x54\x5e\x38\x72\x76\x0a\xb7", // px
        "\x36\x17\xde\x4a\x96\x26\x2c\x6f\x5d\x9e\x98\xbf\x92\x92\xdc\x29\xf8\xf4\x1d\xbd\x28\x9a\x14\x7c\xe9\xda\x31\x13\xb5\xf0\xb8\xc0\x0a\x60\xb1\xce\x1d\x7e\x81\x9d\x7a\x43\x1d\x7c\x90\xea\x0e\x5f", // py
        "\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xc7\x63\x4d\x81\xf4\x37\x2d\xdf\x58\x1a\x0d\xb2\x48\xb0\xa7\x7a\xec\xec\x19\x6a\xcc\xc5\x29\x73", // order
        384, 384, 3, 1, 48, true,
    },
    { /* NISTP521 */
        "\x01\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff", // prime
        "\x01\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfc", // a
        "\x00\x51\x95\x3e\xb9\x61\x8e\x1c\x9a\x1f\x92\x9a\x21\xa0\xb6\x85\x40\xee\xa2\xda\x72\x5b\x99\xb3\x15\xf3\xb8\xb4\x89\x91\x8e\xf1\x09\xe1\x56\x19\x39\x51\xec\x7e\x93\x7b\x16\x52\xc0\xbd\x3b\xb1\xbf\x07\x35\x73\xdf\x88\x3d\x2c\x34\xf1\xef\x45\x1f\xd4\x6b\x50\x3f\x00", // b
        "\x00\xc6\x85\x8e\x06\xb7\x04\x04\xe9\xcd\x9e\x3e\xcb\x66\x23\x95\xb4\x42\x9c\x64\x81\x39\x05\x3f\xb5\x21\xf8\x28\xaf\x60\x6b\x4d\x3d\xba\xa1\x4b\x5e\x77\xef\xe7\x59\x28\xfe\x1d\xc1\x27\xa2\xff\xa8\xde\x33\x48\xb3\xc1\x85\x6a\x42\x9b\xf9\x7e\x7e\x31\xc2\xe5\xbd\x66", // px
        "\x01\x18\x39\x29\x6a\x78\x9a\x3b\xc0\x04\x5c\x8a\x5f\xb4\x2c\x7d\x1b\xd9\x98\xf5\x44\x49\x57\x9b\x44\x68\x17\xaf\xbd\x17\x27\x3e\x66\x2c\x97\xee\x72\x99\x5e\xf4\x26\x40\xc5\x50\xb9\x01\x3f\xad\x07\x61\x35\x3c\x70\x86\xa2\x72\xc2\x40\x88\xbe\x94\x76\x9f\xd1\x66\x50", // py
        "\x01\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xfa\x51\x86\x87\x83\xbf\x2f\x96\x6b\x7f\xcc\x01\x48\xf7\x09\xa5\xd0\x3b\xb5\xc9\xb8\x89\x9c\x47\xae\xbb\x6f\xb7\x1e\x91\x38\x64\x09", // order
        521, 521, 4, 1, 66, true,
    },
    { /* SM2: */
        "\xff\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff", // prime
        "\xff\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\xff\xfc", // a
        "\x28\xe9\xfa\x9e\x9d\x9f\x5e\x34\x4d\x5a\x9e\x4b\xcf\x65\x09\xa7\xf3\x97\x89\xf5\x15\xab\x8f\x92\xdd\xbc\xbd\x41\x4d\x94\x0e\x93", // b
        "\x32\xc4\xae\x2c\x1f\x19\x81\x19\x5f\x99\x04\x46\x6a\x39\xc9\x94\x8f\xe3\x0b\xbf\xf2\x66\x0b\xe1\x71\x5a\x45\x89\x33\x4c\x74\xc7", // px
        "\xbc\x37\x36\xa2\xf4\xf6\x77\x9c\x59\xbd\xce\xe3\x6b\x69\x21\x53\xd0\xa9\x87\x7c\xc6\x2a\x47\x40\x02\xdf\x32\xe5\x21\x39\xf0\xa0", // py
        "\xff\xff\xff\xfe\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x72\x03\xdf\x6b\x21\xc6\x05\x2b\x53\xbb\xf4\x09\x39\xd5\x41\x23", // order
        256, 256, 2/* XXX field type */, 1, 32, true,
    },
};



int pufs_mbedtls_get_ecname (mbedtls_ecp_group *grp, pufs_ec_name_t *ec_name)
{
    int ret = SUCCESS;
    switch (grp->id)
    {
        case MBEDTLS_ECP_DP_SECP224R1:
            *ec_name = NISTP224;
            break;
        case MBEDTLS_ECP_DP_SECP256R1:
            *ec_name = NISTP256;
            break;

        default:
            ret = MBEDTLS_ERR_ECP_FEATURE_UNAVAILABLE;
            break;
    }
    return ret;
}

#if defined(MBEDTLS_ECDSA_VERIFY_ALT)
/*
 * Verify ECDSA signature of hashed message (SEC1 4.1.4)
 * Obviously, compared to SEC1 4.1.3, we skip step 2 (hash message)
 *
 */
int pufs_mbedtls_ecdsa_verify( mbedtls_ecp_group *grp,
                               const unsigned char *buf, size_t blen,
                               const mbedtls_ecp_point *Q, const mbedtls_mpi *r, const mbedtls_mpi *s)
{

    pufs_dgst_st md;
    pufs_ec_point_st puk;
    pufs_ecdsa_sig_st sig;
    pufs_ec_name_t ec_name = N_ECNAME_T;
    uint32_t x_len, y_len, r_len, s_len;
    pufs_status_t status  = SUCCESS;
    int ret;

    x_len = 0;
    y_len = 0;
    r_len = 0;
    s_len = 0;
    memset(&md, 0, sizeof(pufs_dgst_st));

    PUFS_LOG_FUNC("pufs_mbedtls_ecdsa_verify hashlen:%d\n", blen);

    /* Fail cleanly on curves such as Curve25519 that can't be used for ECDSA */
    if ( grp->N.p == NULL )
    {
        return ( MBEDTLS_ERR_ECP_BAD_INPUT_DATA );
    }

    /*
     * Step 1: make sure r and s are in range 1..n-1
     */
    if ( mbedtls_mpi_cmp_int( r, 1 ) < 0 || mbedtls_mpi_cmp_mpi( r, &grp->N ) >= 0 ||
         mbedtls_mpi_cmp_int( s, 1 ) < 0 || mbedtls_mpi_cmp_mpi( s, &grp->N ) >= 0 )
    {
        ret = MBEDTLS_ERR_ECP_VERIFY_FAILED;
        goto cleanup;
    }


    /*
     * Additional precaution: make sure Q is valid
     */
    MBEDTLS_MPI_CHK( mbedtls_ecp_check_pubkey( grp, Q ) );


#if 1
    ret = pufs_mbedtls_get_ecname(grp, &ec_name);
    if (ret != 0)
    {
        goto cleanup;
    }
#else
    switch (grp->id)
    {
        case MBEDTLS_ECP_DP_SECP224R1:
            ec_name = NISTP224;
            break;
        case MBEDTLS_ECP_DP_SECP256R1:
            ec_name = NISTP256;
            break;

        default:
            ret = MBEDTLS_ERR_ECP_FEATURE_UNAVAILABLE;
            goto cleanup;
            break;
    }
#endif

    //public key length check
    x_len = mbedtls_mpi_size(&(Q->X));
    y_len = mbedtls_mpi_size(&(Q->Y));

    if ((x_len != ecc_param[ec_name].len) || (y_len != ecc_param[ec_name].len))
    {
        ret = MBEDTLS_ERR_ECP_INVALID_KEY;
        goto cleanup;
    }

    //Read public key - x, y
    puk.qlen =  ecc_param[ec_name].len;
    if (mbedtls_mpi_write_binary( &(Q->X), puk.x, puk.qlen ) != 0)
    {
        ret = MBEDTLS_ERR_ECP_INVALID_KEY;
        goto cleanup;
    }

    if (mbedtls_mpi_write_binary( &(Q->Y), puk.y, puk.qlen ) != 0)
    {
        ret = MBEDTLS_ERR_ECP_INVALID_KEY;
        goto cleanup;
    }

    //signature length check, r,s
    r_len = mbedtls_mpi_size(r);
    s_len = mbedtls_mpi_size(s);
    if ((r_len != ecc_param[ec_name].len) || (s_len != ecc_param[ec_name].len))
    {
        ret = MBEDTLS_ERR_ECP_VERIFY_FAILED;
        goto cleanup;
    }
    //Read r,s
    sig.qlen = ecc_param[ec_name].len;
    if (mbedtls_mpi_write_binary( r, sig.r, sig.qlen ) != 0)
    {
        ret = MBEDTLS_ERR_ECP_VERIFY_FAILED;
        goto cleanup;
    }

    if (mbedtls_mpi_write_binary( s, sig.s, puk.qlen ) != 0)
    {
        ret = MBEDTLS_ERR_ECP_VERIFY_FAILED;
        goto cleanup;
    }


    if ((status = pufs_ecp_set_curve_byname(ec_name)) != SUCCESS)
    {
        ret = MBEDTLS_ERR_ECP_HW_ACCEL_FAILED;
        goto cleanup;
    }

    md.dlen = blen;
    memcpy(md.dgst, buf, blen);
    status = pufs_ecp_ecdsa_verify_dgst (sig, md, puk);

    if ((status == E_VERFAIL) || (status == E_INVALID))
    {
        ret = MBEDTLS_ERR_ECP_VERIFY_FAILED;
        goto cleanup;
    }
    else if (status != SUCCESS)
    {
        ret = MBEDTLS_ERR_ECP_HW_ACCEL_FAILED;
        goto cleanup;
    }

cleanup:
    if (ret != 0)
    {
        PUFS_LOG_ERR("pufs_mbedtls_ecdsa_verify failed : ret:0x%d, status:%d\n", ret, status);
    }

    return ret;
}
#endif /* MBEDTLS_ECDSA_VERIFY_ALT */


#endif /* PUFS_MBEDTLS_ECDSA_C */
